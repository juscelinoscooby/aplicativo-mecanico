<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checklist T√©cnico Interativo</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef2f7;
      margin: 0;
      padding: 0;
    }

    .chat-container {
      max-width: 700px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .bot, .user {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
    }

    .bot {
      background: #dceeff;
      align-self: flex-start;
    }

    .user {
      background: #c1f0d6;
      align-self: flex-end;
      text-align: right;
    }

    #userInput {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 10px;
      padding: 10px;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #005fa3;
    }

    input[type="file"] {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="chat-container" id="chatbox">
    <div class="bot">Ol√°! Vamos come√ßar o checklist t√©cnico. Qual o nome do equipamento?</div>
  </div>

  <input type="text" id="userInput" placeholder="Digite sua resposta..." />
  <button onclick="processarResposta()">Enviar</button>
  <button onclick="gerarPDF()">üìÑ Gerar PDF</button>
 <button onclick="window.location.href='../index.html'" class="btn-voltar">
      ‚¨ÖÔ∏è Voltar ao Menu
    </button>
  <script>
    // Registrar Service Worker para PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }

    const { jsPDF } = window.jspdf;
    const respostas = {};
    const imagens = {
      equipamento: [],
      etiqueta: [],
      defeito: [],
      local: []
    };

    const perguntas = [
      { chave: "equipamento", texto: "Qual o nome do equipamento?" },
      { chave: "data", texto: "Qual a data da inspe√ß√£o?" },
      { chave: "local", texto: "Qual o local do equipamento?" },
      { chave: "tipo", texto: "Qual o tipo de equipamento? (quadro el√©trico, computador, setor...)" },
      { chave: "status", texto: "Qual o status do equipamento?" },
      { chave: "defeito", texto: "Descreva o defeito encontrado." },
      { chave: "solucao", texto: "Qual foi a solu√ß√£o aplicada?" },
      { chave: "observacoes", texto: "Observa√ß√µes adicionais?" },
      { chave: "tecnico", texto: "Nome do t√©cnico respons√°vel?" },
      { chave: "fotos", texto: "Agora vamos capturar as imagens. Use a c√¢mera para registrar cada item." }
    ];

    let etapa = 0;

    function processarResposta() {
      const input = document.getElementById("userInput").value;
      if (etapa < perguntas.length - 1) {
        const chave = perguntas[etapa].chave;
        respostas[chave] = input;
        adicionarMensagem("user", input);
        etapa++;
        adicionarMensagem("bot", perguntas[etapa].texto);
        document.getElementById("userInput").value = "";
        if (perguntas[etapa].chave === "fotos") {
          mostrarInputsDeImagem();
        }
      }
    }

    function adicionarMensagem(tipo, texto) {
      const div = document.createElement("div");
      div.className = tipo;
      div.textContent = texto;
      document.getElementById("chatbox").appendChild(div);
    }

    function mostrarInputsDeImagem() {
      const container = document.getElementById("chatbox");
      ["equipamento", "etiqueta", "defeito", "local"].forEach(categoria => {
        const label = document.createElement("label");
        label.textContent = `Foto de ${categoria}:`;
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.capture = "environment";
        input.onchange = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = ev => imagens[categoria].push(ev.target.result);
            reader.readAsDataURL(file);
          }
        };
        container.appendChild(label);
        container.appendChild(input);
      });
    }

    function gerarPDF() {
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const margem = 40;
      let y = 40;
      const alturaLinha = 20;
      const larguraMax = doc.internal.pageSize.getWidth() - margem * 2;

      doc.setFontSize(14);
      doc.text("Checklist T√©cnico Interativo", margem, y);
      y += alturaLinha * 2;

      doc.setFontSize(11);
      for (let chave in respostas) {
        const texto = `${chave.charAt(0).toUpperCase() + chave.slice(1)}: ${respostas[chave]}`;
        doc.text(doc.splitTextToSize(texto, larguraMax), margem, y);
        y += alturaLinha;
      }

      y += alturaLinha;

      for (let categoria in imagens) {
        if (imagens[categoria].length > 0) {
          doc.text(`Foto de ${categoria}:`, margem, y);
          y += 10;
          imagens[categoria].forEach(img => {
            doc.addImage(img, 'JPEG', margem, y, 200, 0);
            y += 210;
          });
        }
      }

      doc.save("checklist-tecnico.pdf");
    }
  </script>
</body>
</html>